<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abu Cargo</title>
    <style>
        /* Общие стили */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Стили для форм */
        .form-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-block {
            display: block;
            width: 100%;
            padding: 12px;
        }

        .link {
            text-align: center;
            margin-top: 15px;
        }

        .link a {
            color: #3498db;
            text-decoration: none;
        }

        .link a:hover {
            text-decoration: underline;
        }

        /* Стили для личного кабинета */
        .dashboard {
            display: none;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #34495e;
            color: white;
            transition: left 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background-color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu li {
            border-bottom: 1px solid #3c5064;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .sidebar-menu a:hover {
            background-color: #3c5064;
        }

        .content {
            padding: 20px;
        }

        .section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .user-code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .user-code h4 {
            margin-bottom: 10px;
        }

        .user-code p {
            margin-bottom: 5px;
        }

        /* Стили для админ-панели */
        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th,
        table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        table tr:hover {
            background-color: #f5f5f5;
        }

        .status-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .track-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .form-container {
                margin: 20px auto;
                padding: 20px;
            }

            .sidebar {
                width: 100%;
                left: -100%;
            }

            table {
                display: block;
                overflow-x: auto;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Форма входа -->
    <div id="loginForm" class="form-container">
        <h2>Вход в Abu Cargo</h2>
        <form id="loginFormElement">
            <div class="form-group">
                <label for="loginPhone">Номер телефона</label>
                <input type="tel" id="loginPhone" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Пароль</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-block">Войти</button>
        </form>
        <div class="link">
            <a href="#" id="showRegister">Нет аккаунта? Зарегистрируйтесь</a>
        </div>
    </div>

    <!-- Форма регистрации -->
    <div id="registerForm" class="form-container" style="display: none;">
        <h2>Регистрация в Abu Cargo</h2>
        <form id="registerFormElement">
            <div class="form-group">
                <label for="registerName">ФИО</label>
                <input type="text" id="registerName" required>
            </div>
            <div class="form-group">
                <label for="registerPhone">Номер телефона</label>
                <input type="tel" id="registerPhone" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">Пароль</label>
                <input type="password" id="registerPassword" required>
            </div>
            <div class="form-group">
                <label for="registerPvz">ПВЗ</label>
                <select id="registerPvz" required>
                    <option value="">Выберите ПВЗ</option>
                    <option value="Нариман">Нариман</option>
                    <option value="Жийдалик УПТК">Жийдалик УПТК</option>
                    <option value="Достук">Достук</option>
                </select>
            </div>
            <button type="submit" class="btn btn-block">Зарегистрироваться</button>
        </form>
        <div class="link">
            <a href="#" id="showLogin">Уже есть аккаунт? Войдите</a>
        </div>
    </div>

    <!-- Личный кабинет пользователя -->
    <div id="userDashboard" class="dashboard">
        <div class="header">
            <div class="container header-content">
                <button class="menu-btn" id="menuBtn">☰</button>
                <h1 id="dashboardTitle">Abu Cargo — твой код YX1</h1>
                <button class="btn btn-secondary" id="logoutBtn">Выйти</button>
            </div>
        </div>

        <!-- Боковая панель -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Меню</h3>
                <button class="close-btn" id="closeBtn">×</button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" data-section="personalData">Личные данные</a></li>
                <li><a href="#" data-section="changePassword">Изменение пароля</a></li>
                <li><a href="#" data-section="orderStatus">Статус товаров</a></li>
            </ul>
        </div>

        <!-- Основной контент -->
        <div class="container content">
            <!-- Информация о коде пользователя -->
            <div class="user-code" id="userCodeInfo">
                <h4>Ваш код: <span id="userCodeSpan">YX1</span></h4>
                <p>Адрес в Китае:</p>
                <p id="chinaAddress">御玺(YX1)<br>15727306315<br>浙江省金华市义乌市北苑街道春晗二区36栋好运国际货运5697库入仓号:御玺(YX1)</p>
            </div>

            <!-- Раздел личных данных -->
            <div id="personalData" class="section active">
                <h3>Личные данные</h3>
                <form id="personalDataForm">
                    <div class="form-group">
                        <label for="editName">ФИО</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Номер телефона</label>
                        <input type="tel" id="editPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="editPvz">ПВЗ</label>
                        <select id="editPvz" required>
                            <option value="Нариман">Нариман</option>
                            <option value="Жийдалик УПТК">Жийдалик УПТК</option>
                            <option value="Достук">Достук</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-block">Сохранить изменения</button>
                </form>
            </div>

            <!-- Раздел изменения пароля -->
            <div id="changePassword" class="section">
                <h3>Изменение пароля</h3>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="newPassword">Новый пароль</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Подтвердите пароль</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-block">Изменить пароль</button>
                </form>
            </div>

            <!-- Раздел статуса товаров -->
            <div id="orderStatus" class="section">
                <h3>Статус товаров</h3>
                <div id="orderStatusContent">
                    <p>Здесь будет отображаться статус ваших заказов.</p>
                    <ul id="orderList">
                        <!-- Список заказов будет заполняться динамически -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Админ-панель -->
    <div id="adminDashboard" class="dashboard">
        <div class="header">
            <div class="container header-content">
                <h1>Админ-панель Abu Cargo</h1>
                <button class="btn btn-secondary" id="adminLogoutBtn">Выйти</button>
            </div>
        </div>

        <div class="container content">
            <!-- Навигация админ-панели -->
            <div class="admin-nav" style="margin-bottom: 20px;">
                <button class="btn" data-admin-section="inTransit">В дороге</button>
                <button class="btn" data-admin-section="userSearch">Поиск пользователей</button>
                <button class="btn" data-admin-section="allUsers">Все пользователи</button>
            </div>

            <!-- Раздел "В дороге" -->
            <div id="inTransit" class="admin-section active">
                <h3>Заказы в дороге</h3>
                <div id="inTransitContent">
                    <table>
                        <thead>
                            <tr>
                                <th>Пользователь</th>
                                <th>Трек код</th>
                                <th>Статус</th>
                                <th>Дата добавления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="inTransitTable">
                            <!-- Данные будут заполняться динамически -->
                        </tbody>
                    </table>
                    <button class="btn btn-success" id="addNewOrder">+ Добавить новый заказ</button>
                </div>
            </div>

            <!-- Раздел поиска пользователей -->
            <div id="userSearch" class="admin-section">
                <h3>Поиск пользователей</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Поиск по ФИО, телефону или коду">
                </div>
                <div id="searchResults">
                    <table>
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>ФИО</th>
                                <th>Телефон</th>
                                <th>ПВЗ</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsTable">
                            <!-- Результаты поиска будут отображаться здесь -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Раздел всех пользователей -->
            <div id="allUsers" class="admin-section">
                <h3>Все пользователи</h3>
                <div id="allUsersContent">
                    <table>
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>ФИО</th>
                                <th>Телефон</th>
                                <th>ПВЗ</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable">
                            <!-- Данные будут заполняться динамически -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация базы данных
        function initDatabase() {
            if (!localStorage.getItem('abucargo_users')) {
                localStorage.setItem('abucargo_users', JSON.stringify([]));
            }
            if (!localStorage.getItem('abucargo_next_code')) {
                localStorage.setItem('abucargo_next_code', '1');
            }
            if (!localStorage.getItem('abucargo_orders')) {
                localStorage.setItem('abucargo_orders', JSON.stringify([]));
            }
            
            // Создаем админ-аккаунт, если его нет
            const users = JSON.parse(localStorage.getItem('abucargo_users'));
            const adminExists = users.some(user => user.phone === '+996550997000');
            
            if (!adminExists) {
                const adminUser = {
                    id: 'admin',
                    name: 'Администратор',
                    phone: '+996550997000',
                    password: 'admin', // Для админа не шифруем пароль
                    pvz: 'Админ',
                    code: 'ADMIN',
                    registrationDate: new Date().toISOString(),
                    isAdmin: true // Добавляем флаг администратора
                };
                users.push(adminUser);
                localStorage.setItem('abucargo_users', JSON.stringify(users));
            }
        }

        // Генерация следующего кода
        function getNextCode() {
            const nextCodeNum = parseInt(localStorage.getItem('abucargo_next_code'));
            const nextCode = `YX${nextCodeNum}`;
            localStorage.setItem('abucargo_next_code', (nextCodeNum + 1).toString());
            return nextCode;
        }

        // Простое шифрование пароля
        function simpleEncrypt(password) {
            return btoa(password);
        }

        // Проверка пароля
        function checkPassword(inputPassword, storedPassword, isAdmin = false) {
            if (isAdmin) {
                return inputPassword === storedPassword;
            }
            return simpleEncrypt(inputPassword) === storedPassword;
        }

        // Регистрация пользователя
        function registerUser(name, phone, password, pvz) {
            const users = JSON.parse(localStorage.getItem('abucargo_users'));
            
            const userExists = users.some(user => user.phone === phone);
            if (userExists) {
                alert('Пользователь с таким номером телефона уже зарегистрирован');
                return false;
            }
            
            const newUser = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                password: simpleEncrypt(password),
                pvz: pvz,
                code: getNextCode(),
                registrationDate: new Date().toISOString(),
                isAdmin: false
            };
            
            users.push(newUser);
            localStorage.setItem('abucargo_users', JSON.stringify(users));
            
            return newUser;
        }

        // Авторизация пользователя
        function loginUser(phone, password) {
            const users = JSON.parse(localStorage.getItem('abucargo_users'));
            const user = users.find(u => u.phone === phone);
            
            if (!user) {
                return null;
            }
            
            const isAdmin = user.phone === '+996550997000';
            
            if (checkPassword(password, user.password, isAdmin)) {
                return user;
            }
            
            return null;
        }

        // Обновление данных пользователя
        function updateUser(userId, updates) {
            const users = JSON.parse(localStorage.getItem('abucargo_users'));
            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                if (updates.password && !users[userIndex].isAdmin) {
                    updates.password = simpleEncrypt(updates.password);
                }
                
                users[userIndex] = { ...users[userIndex], ...updates };
                localStorage.setItem('abucargo_users', JSON.stringify(users));
                return users[userIndex];
            }
            
            return null;
        }

        // Получение всех пользователей
        function getAllUsers() {
            return JSON.parse(localStorage.getItem('abucargo_users'));
        }

        // Получение всех заказов
        function getAllOrders() {
            return JSON.parse(localStorage.getItem('abucargo_orders'));
        }

        // Добавление нового заказа
        function addOrder(userId, trackCode, status) {
            const orders = getAllOrders();
            const newOrder = {
                id: Date.now().toString(),
                userId: userId,
                trackCode: trackCode,
                status: status,
                dateAdded: new Date().toISOString()
            };
            
            orders.push(newOrder);
            localStorage.setItem('abucargo_orders', JSON.stringify(orders));
            return newOrder;
        }

        // Обновление заказа
        function updateOrder(orderId, updates) {
            const orders = getAllOrders();
            const orderIndex = orders.findIndex(o => o.id === orderId);
            
            if (orderIndex !== -1) {
                orders[orderIndex] = { ...orders[orderIndex], ...updates };
                localStorage.setItem('abucargo_orders', JSON.stringify(orders));
                return orders[orderIndex];
            }
            
            return null;
        }

        // Удаление заказа
        function deleteOrder(orderId) {
            const orders = getAllOrders();
            const updatedOrders = orders.filter(order => order.id !== orderId);
            localStorage.setItem('abucargo_orders', JSON.stringify(updatedOrders));
        }

        // Поиск пользователей
        function searchUsers(query) {
            const users = getAllUsers();
            return users.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.phone.includes(query) ||
                user.code.toLowerCase().includes(query.toLowerCase())
            );
        }

        // Получение адреса в Китае с кодом пользователя
        function getChinaAddress(code) {
            return `御玺(${code})<br>15727306315<br>浙江省金华市义乌市北苑街道春晗二区36栋好运国际货运5697库入仓号:御玺(${code})`;
        }

        // Вход под пользователем (для админа)
        function loginAsUser(userId) {
            const users = getAllUsers();
            const user = users.find(u => u.id === userId);
            if (user) {
                showDashboard(user);
            }
        }

        // DOM элементы
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginFormElement = document.getElementById('loginFormElement');
        const registerFormElement = document.getElementById('registerFormElement');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const menuBtn = document.getElementById('menuBtn');
        const closeBtn = document.getElementById('closeBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const sections = document.querySelectorAll('.section');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const personalDataForm = document.getElementById('personalDataForm');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const adminNavButtons = document.querySelectorAll('.admin-nav button');
        const adminSections = document.querySelectorAll('.admin-section');
        const searchInput = document.getElementById('searchInput');
        const inTransitTable = document.getElementById('inTransitTable');
        const searchResultsTable = document.getElementById('searchResultsTable');
        const allUsersTable = document.getElementById('allUsersTable');
        const dashboardTitle = document.getElementById('dashboardTitle');
        const userCodeSpan = document.getElementById('userCodeSpan');
        const chinaAddress = document.getElementById('chinaAddress');
        const orderList = document.getElementById('orderList');
        const addNewOrderBtn = document.getElementById('addNewOrder');

        // Текущий пользователь
        let currentUser = null;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            initDatabase();
            
            const activeUser = localStorage.getItem('abucargo_active_user');
            if (activeUser) {
                const user = JSON.parse(activeUser);
                showDashboard(user);
            }
            
            setupEventListeners();
        });

        // Настройка обработчиков событий
        function setupEventListeners() {
            showRegisterLink.addEventListener('click', function(e) {
                e.preventDefault();
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            });
            
            showLoginLink.addEventListener('click', function(e) {
                e.preventDefault();
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
            });
            
            loginFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                const phone = document.getElementById('loginPhone').value;
                const password = document.getElementById('loginPassword').value;
                
                const user = loginUser(phone, password);
                if (user) {
                    showDashboard(user);
                } else {
                    alert('Неверный номер телефона или пароль');
                }
            });
            
            registerFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const phone = document.getElementById('registerPhone').value;
                const password = document.getElementById('registerPassword').value;
                const pvz = document.getElementById('registerPvz').value;
                
                const newUser = registerUser(name, phone, password, pvz);
                if (newUser) {
                    alert(`Регистрация успешна! Ваш код: ${newUser.code}`);
                    showDashboard(newUser);
                }
            });
            
            menuBtn.addEventListener('click', function() {
                sidebar.classList.add('active');
            });
            
            closeBtn.addEventListener('click', function() {
                sidebar.classList.remove('active');
            });
            
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.getAttribute('data-section');
                    
                    sections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    document.getElementById(targetSection).classList.add('active');
                    sidebar.classList.remove('active');
                });
            });
            
            logoutBtn.addEventListener('click', function() {
                localStorage.removeItem('abucargo_active_user');
                currentUser = null;
                userDashboard.style.display = 'none';
                loginForm.style.display = 'block';
            });
            
            adminLogoutBtn.addEventListener('click', function() {
                localStorage.removeItem('abucargo_active_user');
                currentUser = null;
                adminDashboard.style.display = 'none';
                loginForm.style.display = 'block';
            });
            
            personalDataForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('editName').value;
                const phone = document.getElementById('editPhone').value;
                const pvz = document.getElementById('editPvz').value;
                
                const updatedUser = updateUser(currentUser.id, { name, phone, pvz });
                if (updatedUser) {
                    currentUser = updatedUser;
                    localStorage.setItem('abucargo_active_user', JSON.stringify(currentUser));
                    updateUserInterface();
                    alert('Данные успешно обновлены');
                }
            });
            
            changePasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    alert('Пароли не совпадают');
                    return;
                }
                
                const updatedUser = updateUser(currentUser.id, { password: newPassword });
                if (updatedUser) {
                    currentUser = updatedUser;
                    localStorage.setItem('abucargo_active_user', JSON.stringify(currentUser));
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    alert('Пароль успешно изменен');
                }
            });
            
            adminNavButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-admin-section');
                    
                    adminSections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    document.getElementById(targetSection).classList.add('active');
                    
                    if (targetSection === 'inTransit') {
                        loadInTransitData();
                    } else if (targetSection === 'allUsers') {
                        loadAllUsersData();
                    }
                });
            });
            
            searchInput.addEventListener('input', function() {
                const query = this.value;
                if (query.length >= 2) {
                    const results = searchUsers(query);
                    displaySearchResults(results);
                } else {
                    searchResultsTable.innerHTML = '';
                }
            });

            addNewOrderBtn.addEventListener('click', function() {
                addNewOrder();
            });
        }

        // Показать соответствующий дашборд
        function showDashboard(user) {
            currentUser = user;
            localStorage.setItem('abucargo_active_user', JSON.stringify(user));
            
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            
            if (user.phone === '+996550997000') {
                adminDashboard.style.display = 'block';
                userDashboard.style.display = 'none';
                loadAdminData();
            } else {
                userDashboard.style.display = 'block';
                adminDashboard.style.display = 'none';
                updateUserInterface();
            }
        }

        // Обновление интерфейса пользователя
        function updateUserInterface() {
            dashboardTitle.textContent = `Abu Cargo — твой код ${currentUser.code}`;
            userCodeSpan.textContent = currentUser.code;
            chinaAddress.innerHTML = getChinaAddress(currentUser.code);
            
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editPhone').value = currentUser.phone;
            document.getElementById('editPvz').value = currentUser.pvz;
            
            loadUserOrders();
        }

        // Загрузка заказов пользователя
        function loadUserOrders() {
            const orders = getAllOrders();
            const userOrders = orders.filter(order => order.userId === currentUser.id);
            
            orderList.innerHTML = '';
            
            if (userOrders.length === 0) {
                orderList.innerHTML = '<li>Нет активных заказов</li>';
                return;
            }
            
            userOrders.forEach(order => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>Трек: ${order.trackCode}</strong> - ${order.status} (добавлен: ${new Date(order.dateAdded).toLocaleDateString('ru-RU')})`;
                orderList.appendChild(li);
            });
        }

        // Загрузка данных для админ-панели
        function loadAdminData() {
            loadInTransitData();
            loadAllUsersData();
        }

        // Загрузка данных для раздела "В дороге"
        function loadInTransitData() {
            const orders = getAllOrders();
            const users = getAllUsers();
            
            inTransitTable.innerHTML = '';
            
            if (orders.length === 0) {
                inTransitTable.innerHTML = '<tr><td colspan="5" style="text-align: center;">Нет заказов</td></tr>';
                return;
            }
            
            orders.forEach(order => {
                const user = users.find(u => u.id === order.userId);
                if (!user) return;
                
                const row = document.createElement('tr');
                const dateAdded = new Date(order.dateAdded).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${user.name} (${user.code})</td>
                    <td><input type="text" class="track-input" value="${order.trackCode}" data-order-id="${order.id}"></td>
                    <td>
                        <select class="status-select" data-order-id="${order.id}">
                            <option value="В пути" ${order.status === 'В пути' ? 'selected' : ''}>В пути</option>
                            <option value="Ожидает" ${order.status === 'Ожидает' ? 'selected' : ''}>Ожидает</option>
                            <option value="Получен" ${order.status === 'Получен' ? 'selected' : ''}>Получен</option>
                        </select>
                    </td>
                    <td>${dateAdded}</td>
                    <td>
                        <button class="btn btn-success save-order" data-order-id="${order.id}">Сохранить</button>
                        <button class="btn btn-danger delete-order" data-order-id="${order.id}">Удалить</button>
                    </td>
                `;
                
                inTransitTable.appendChild(row);
            });
            
            // Обработчики для сохранения заказов
            document.querySelectorAll('.save-order').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    const trackInput = document.querySelector(`.track-input[data-order-id="${orderId}"]`);
                    const statusSelect = document.querySelector(`.status-select[data-order-id="${orderId}"]`);
                    
                    const updates = {
                        trackCode: trackInput.value,
                        status: statusSelect.value
                    };
                    
                    updateOrder(orderId, updates);
                    alert('Заказ обновлен');
                    loadInTransitData();
                });
            });
            
            // Обработчики для удаления заказов
            document.querySelectorAll('.delete-order').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    if (confirm('Удалить этот заказ?')) {
                        deleteOrder(orderId);
                        loadInTransitData();
                    }
                });
            });
        }

        // Добавление нового заказа
        function addNewOrder() {
            const users = getAllUsers().filter(user => !user.isAdmin);
            
            if (users.length === 0) {
                alert('Нет пользователей для добавления заказа');
                return;
            }
            
            let userOptions = '';
            users.forEach(user => {
                userOptions += `<option value="${user.id}">${user.name} (${user.code})</option>`;
            });
            
            const userSelect = prompt(`Выберите пользователя:\n${userOptions}`, users[0].id);
            if (!userSelect) return;
            
            const trackCode = prompt('Введите трек код:');
            if (!trackCode) return;
            
            const status = prompt('Выберите статус (В пути/Ожидает/Получен):', 'В пути');
            if (!status) return;
            
            addOrder(userSelect, trackCode, status);
            alert('Заказ добавлен');
            loadInTransitData();
        }

        // Загрузка данных для раздела "Все пользователи"
        function loadAllUsersData() {
            const users = getAllUsers().filter(user => !user.isAdmin);
            
            allUsersTable.innerHTML = '';
            
            if (users.length === 0) {
                allUsersTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">Нет пользователей</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const regDate = new Date(user.registrationDate).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${user.code}</td>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${user.pvz}</td>
                    <td>${regDate}</td>
                    <td>
                        <button class="btn btn-success login-as-user" data-user-id="${user.id}">Войти как пользователь</button>
                        <button class="btn btn-secondary edit-user" data-user-id="${user.id}">Изменить пароль</button>
                        <button class="btn btn-danger delete-user" data-user-id="${user.id}">Удалить</button>
                    </td>
                `;
                
                allUsersTable.appendChild(row);
            });
            
            // Обработчики для кнопок
            document.querySelectorAll('.login-as-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    loginAsUser(userId);
                });
            });
            
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    changeUserPassword(userId);
                });
            });
            
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    if (confirm('Удалить этого пользователя?')) {
                        deleteUser(userId);
                        loadAllUsersData();
                    }
                });
            });
        }

        // Изменение пароля пользователя
        function changeUserPassword(userId) {
            const newPassword = prompt('Введите новый пароль:');
            if (newPassword) {
                updateUser(userId, { password: newPassword });
                alert('Пароль изменен');
            }
        }

        // Отображение результатов поиска
        function displaySearchResults(results) {
            searchResultsTable.innerHTML = '';
            
            if (results.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">Пользователи не найдены</td>';
                searchResultsTable.appendChild(row);
                return;
            }
            
            results.forEach(user => {
                if (user.isAdmin) return;
                
                const row = document.createElement('tr');
                const regDate = new Date(user.registrationDate).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${user.code}</td>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${user.pvz}</td>
                    <td>${regDate}</td>
                    <td>
                        <button class="btn btn-success login-as-user" data-user-id="${user.id}">Войти как пользователь</button>
                        <button class="btn btn-secondary edit-user" data-user-id="${user.id}">Изменить пароль</button>
                    </td>
                `;
                
                searchResultsTable.appendChild(row);
            });
            
            // Обработчики для кнопок в результатах поиска
            document.querySelectorAll('#searchResultsTable .login-as-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    loginAsUser(userId);
                });
            });
            
            document.querySelectorAll('#searchResultsTable .edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    changeUserPassword(userId);
                });
            });
        }

        // Удаление пользователя
        function deleteUser(userId) {
            const users = getAllUsers();
            const updatedUsers = users.filter(user => user.id !== userId);
            localStorage.setItem('abucargo_users', JSON.stringify(updatedUsers));
            
            // Также удаляем заказы пользователя
            const orders = getAllOrders();
            const updatedOrders = orders.filter(order => order.userId !== userId);
            localStorage.setItem('abucargo_orders', JSON.stringify(updatedOrders));
        }
    </script>
</body>
  </html>
