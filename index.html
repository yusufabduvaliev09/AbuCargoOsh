<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abu Cargo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .form-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-container h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 2px;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-secondary {
            background-color: #95a5a6;
        }

        .btn-secondary:hover {
            background-color: #7f8c8d;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: #27ae60;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        .btn-telegram {
            background-color: #0088cc;
        }

        .btn-telegram:hover {
            background-color: #0077b3;
        }

        .btn-block {
            display: block;
            width: 100%;
            padding: 12px;
        }

        .link {
            text-align: center;
            margin-top: 15px;
        }

        .link a {
            color: #3498db;
            text-decoration: none;
        }

        .link a:hover {
            text-decoration: underline;
        }

        .dashboard {
            display: none;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .menu-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: #34495e;
            color: white;
            transition: left 0.3s;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            background-color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu li {
            border-bottom: 1px solid #3c5064;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .sidebar-menu a:hover {
            background-color: #3c5064;
        }

        .content {
            padding: 20px;
        }

        .section {
            display: none;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .section.active {
            display: block;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .user-code {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .user-code h4 {
            margin-bottom: 10px;
        }

        .user-code p {
            margin-bottom: 5px;
        }

        .add-track-form {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            border-left: 4px solid #27ae60;
        }

        .profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .profile-card h3 {
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.3);
        }

        .profile-info {
            margin-top: 15px;
        }

        .profile-info p {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        .profile-info i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        table th,
        table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        table tr:hover {
            background-color: #f5f5f5;
        }

        .status-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .track-input {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 150px;
        }

        .user-select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }

        @media (max-width: 768px) {
            .form-container {
                margin: 20px auto;
                padding: 20px;
            }

            .sidebar {
                width: 100%;
                left: -100%;
            }

            table {
                display: block;
                overflow-x: auto;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="loginForm" class="form-container">
        <h2>Вход в Abu Cargo</h2>
        <form id="loginFormElement">
            <div class="form-group">
                <label for="loginPhone">Номер телефона</label>
                <input type="tel" id="loginPhone" required>
            </div>
            <div class="form-group">
                <label for="loginPassword">Пароль</label>
                <input type="password" id="loginPassword" required>
            </div>
            <button type="submit" class="btn btn-block">Войти</button>
        </form>
        <div class="link">
            <a href="#" id="showRegister">Нет аккаунта? Зарегистрируйтесь</a>
        </div>
    </div>

    <div id="registerForm" class="form-container" style="display: none;">
        <h2>Регистрация в Abu Cargo</h2>
        <form id="registerFormElement">
            <div class="form-group">
                <label for="registerName">ФИО</label>
                <input type="text" id="registerName" required>
            </div>
            <div class="form-group">
                <label for="registerPhone">Номер телефона</label>
                <input type="tel" id="registerPhone" required>
            </div>
            <div class="form-group">
                <label for="registerPassword">Пароль</label>
                <input type="password" id="registerPassword" required>
            </div>
            <div class="form-group">
                <label for="registerPvz">ПВЗ</label>
                <select id="registerPvz" required>
                    <option value="">Выберите ПВЗ</option>
                    <option value="Нариман">Нариман</option>
                    <option value="Жийдалик УПТК">Жийдалик УПТК</option>
                    <option value="Достук">Достук</option>
                </select>
            </div>
            <button type="submit" class="btn btn-block">Зарегистрироваться</button>
        </form>
        <div class="link">
            <a href="#" id="showLogin">Уже есть аккаунт? Войдите</a>
        </div>
    </div>

    <div id="userDashboard" class="dashboard">
        <div class="header">
            <div class="container header-content">
                <button class="menu-btn" id="menuBtn">☰</button>
                <h1 id="dashboardTitle">Abu Cargo — твой код YX1</h1>
                <button class="btn btn-secondary" id="logoutBtn">Выйти</button>
            </div>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Меню</h3>
                <button class="close-btn" id="closeBtn">×</button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" data-section="profile">Мой профиль</a></li>
                <li><a href="#" data-section="personalData">Личные данные</a></li>
                <li><a href="#" data-section="changePassword">Изменение пароля</a></li>
                <li><a href="#" data-section="orderStatus">Мои заказы</a></li>
                <li><a href="#" data-section="addOrder">Добавить заказ</a></li>
            </ul>
        </div>

        <div class="container content">
            <div id="profile" class="section active">
                <div class="profile-card">
                    <h3>📃 Ваш профиль</h3>
                    <div class="profile-info" id="profileInfo"></div>
                    <button class="btn btn-telegram" id="shareToTelegram" style="margin-top: 15px;">
                        📤 Поделиться в Telegram
                    </button>
                </div>
                
                <div class="user-code">
                    <h4>Адрес в Китае:</h4>
                    <p id="chinaAddress"></p>
                </div>
            </div>

            <div id="personalData" class="section">
                <h3>Личные данные</h3>
                <form id="personalDataForm">
                    <div class="form-group">
                        <label for="editName">ФИО</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group">
                        <label for="editPhone">Номер телефона</label>
                        <input type="tel" id="editPhone" required>
                    </div>
                    <div class="form-group">
                        <label for="editPvz">ПВЗ</label>
                        <select id="editPvz" required>
                            <option value="Нариман">Нариман</option>
                            <option value="Жийдалик УПТК">Жийдалик УПТК</option>
                            <option value="Достук">Достук</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-block">Сохранить изменения</button>
                </form>
            </div>

            <div id="changePassword" class="section">
                <h3>Изменение пароля</h3>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="newPassword">Новый пароль</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Подтвердите пароль</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-block">Изменить пароль</button>
                </form>
            </div>

            <div id="orderStatus" class="section">
                <h3>Мои заказы</h3>
                <div id="orderStatusContent">
                    <table>
                        <thead>
                            <tr>
                                <th>Трек код</th>
                                <th>Статус</th>
                                <th>Дата добавления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="orderList"></tbody>
                    </table>
                </div>
            </div>

            <div id="addOrder" class="section">
                <h3>Добавить новый заказ</h3>
                <div class="add-track-form">
                    <form id="addOrderForm">
                        <div class="form-group">
                            <label for="trackCode">Трек код</label>
                            <input type="text" id="trackCode" placeholder="Введите трек код" required>
                        </div>
                        <button type="submit" class="btn btn-success btn-block">Добавить заказ</button>
                    </form>
                </div>
                <p><small>После добавления заказа ему будет присвоен статус "Ожидает получения". Администратор может изменить статус на "В пути" или "Получен".</small></p>
            </div>
        </div>
    </div>

    <div id="adminDashboard" class="dashboard">
        <div class="header">
            <div class="container header-content">
                <h1>Админ-панель Abu Cargo</h1>
                <button class="btn btn-secondary" id="adminLogoutBtn">Выйти</button>
            </div>
        </div>

        <div class="container content">
            <div class="admin-nav" style="margin-bottom: 20px;">
                <button class="btn" data-admin-section="inTransit">Все заказы</button>
                <button class="btn" data-admin-section="userSearch">Поиск пользователей</button>
                <button class="btn" data-admin-section="allUsers">Все пользователи</button>
            </div>

            <div id="inTransit" class="admin-section active">
                <h3>Все заказы</h3>
                <div class="add-track-form" style="margin-bottom: 20px;">
                    <h4>Добавить заказ для пользователя</h4>
                    <form id="adminAddOrderForm">
                        <div class="form-group">
                            <label for="adminUserCode">Код пользователя</label>
                            <input type="text" id="adminUserCode" placeholder="Введите код (например: YX1)" required>
                        </div>
                        <div class="form-group">
                            <label for="adminTrackCode">Трек код</label>
                            <input type="text" id="adminTrackCode" placeholder="Введите трек код" required>
                        </div>
                        <div class="form-group">
                            <label for="adminOrderStatus">Статус</label>
                            <select id="adminOrderStatus" required>
                                <option value="Ожидает получения">Ожидает получения</option>
                                <option value="В пути">В пути</option>
                                <option value="Получен">Получен</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Добавить заказ</button>
                    </form>
                </div>
                <div id="inTransitContent">
                    <table>
                        <thead>
                            <tr>
                                <th>Пользователь</th>
                                <th>Код</th>
                                <th>Трек код</th>
                                <th>Статус</th>
                                <th>Дата добавления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="inTransitTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="userSearch" class="admin-section">
                <h3>Поиск пользователей</h3>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Поиск по ФИО, телефону или коду">
                </div>
                <div id="searchResults">
                    <table>
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>ФИО</th>
                                <th>Телефон</th>
                                <th>ПВЗ</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsTable"></tbody>
                    </table>
                </div>
            </div>

            <div id="allUsers" class="admin-section">
                <h3>Все пользователи</h3>
                <div id="allUsersContent">
                    <table>
                        <thead>
                            <tr>
                                <th>Код</th>
                                <th>ФИО</th>
                                <th>Телефон</th>
                                <th>ПВЗ</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="allUsersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Улучшенная система хранения данных
        function initDatabase() {
            if (!localStorage.getItem('abucargo_users')) {
                const initialData = [];
                initialData.push({
                    id: 'admin1',
                    name: 'Мусульма Админ',
                    phone: '+996997111118',
                    password: 'muslima06',
                    pvz: 'Админ',
                    code: 'ADMIN1',
                    registrationDate: new Date().toISOString(),
                    isAdmin: true
                });
                initialData.push({
                    id: 'admin2', 
                    name: 'Юсуф Админ',
                    phone: '+996550997200',
                    password: 'yusuf09',
                    pvz: 'Админ',
                    code: 'ADMIN2',
                    registrationDate: new Date().toISOString(),
                    isAdmin: true
                });
                localStorage.setItem('abucargo_users', JSON.stringify(initialData));
            }
            
            if (!localStorage.getItem('abucargo_next_code_yx')) {
                localStorage.setItem('abucargo_next_code_yx', '1');
            }
            if (!localStorage.getItem('abucargo_next_code_yq')) {
                localStorage.setItem('abucargo_next_code_yq', '1');
            }
            
            if (!localStorage.getItem('abucargo_orders')) {
                localStorage.setItem('abucargo_orders', JSON.stringify([]));
            }
        }

        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.error('Ошибка сохранения:', e);
                sessionStorage.setItem(key, value);
                return false;
            }
        }

        function safeGetItem(key) {
            try {
                return localStorage.getItem(key) || sessionStorage.getItem(key);
            } catch (e) {
                return sessionStorage.getItem(key);
            }
        }

        // Генерация следующего кода в зависимости от админа
        function getNextCode(adminPhone) {
            if (adminPhone === '+996997111118') {
                // Админ 1 - YX коды
                const nextCodeNum = parseInt(localStorage.getItem('abucargo_next_code_yx'));
                const nextCode = `YX${nextCodeNum}`;
                localStorage.setItem('abucargo_next_code_yx', (nextCodeNum + 1).toString());
                return nextCode;
            } else {
                // Админ 2 - YQ коды
                const nextCodeNum = parseInt(localStorage.getItem('abucargo_next_code_yq'));
                const nextCode = `YQ${nextCodeNum}`;
                localStorage.setItem('abucargo_next_code_yq', (nextCodeNum + 1).toString());
                return nextCode;
            }
        }

        function getPvzInfo(pvz) {
            const pvzInfo = {
                'Нариман': {
                    phone: '+996997111118',
                    address: 'Нариман',
                    hours: '9:00 ДО 18:00',
                    map: 'https://2gis.kg/bishkek/'
                },
                'Жийдалик УПТК': {
                    phone: '+996997111118',
                    address: 'Жийделик УПТК, Улица Наби Ходжа, 28/3',
                    hours: '9:00 ДО 18:00',
                    map: 'https://2gis.kg/bishkek/geo/70030076876455182/72.781486,40.555853'
                },
                'Достук': {
                    phone: '+996997111118',
                    address: 'Достук',
                    hours: '9:00 ДО 18:00',
                    map: 'https://2gis.kg/bishkek/'
                }
            };
            return pvzInfo[pvz] || pvzInfo['Жийдалик УПТК'];
        }

        function simpleEncrypt(password) {
            return btoa(password);
        }

        function checkPassword(inputPassword, storedPassword, isAdmin = false) {
            if (isAdmin) {
                return inputPassword === storedPassword;
            }
            return simpleEncrypt(inputPassword) === storedPassword;
        }

        // Регистрация пользователя с учетом админа
        function registerUser(name, phone, password, pvz, adminPhone) {
            try {
                const usersData = safeGetItem('abucargo_users');
                const users = usersData ? JSON.parse(usersData) : [];
                
                const userExists = users.some(user => user.phone === phone);
                if (userExists) {
                    alert('Пользователь с таким номером телефона уже зарегистрирован');
                    return false;
                }
                
                const newUser = {
                    id: Date.now().toString(),
                    name: name,
                    phone: phone,
                    password: simpleEncrypt(password),
                    pvz: pvz,
                    code: getNextCode(adminPhone),
                    registrationDate: new Date().toISOString(),
                    isAdmin: false,
                    adminPhone: adminPhone
                };
                
                users.push(newUser);
                safeSetItem('abucargo_users', JSON.stringify(users));
                
                return newUser;
            } catch (e) {
                console.error('Ошибка регистрации:', e);
                return false;
            }
        }

        function loginUser(phone, password) {
            try {
                const usersData = safeGetItem('abucargo_users');
                if (!usersData) return null;
                
                const users = JSON.parse(usersData);
                const user = users.find(u => u.phone === phone);
                
                if (!user) return null;
                
                const isAdmin = user.isAdmin;
                if (checkPassword(password, user.password, isAdmin)) {
                    const userData = JSON.stringify(user);
                    safeSetItem('abucargo_active_user', userData);
                    sessionStorage.setItem('abucargo_active_user', userData);
                    return user;
                }
                return null;
            } catch (e) {
                console.error('Ошибка входа:', e);
                return null;
            }
        }

        function updateUser(userId, updates) {
            try {
                const usersData = safeGetItem('abucargo_users');
                const users = usersData ? JSON.parse(usersData) : [];
                const userIndex = users.findIndex(u => u.id === userId);
                
                if (userIndex !== -1) {
                    if (updates.password && !users[userIndex].isAdmin) {
                        updates.password = simpleEncrypt(updates.password);
                    }
                    
                    users[userIndex] = { ...users[userIndex], ...updates };
                    safeSetItem('abucargo_users', JSON.stringify(users));
                    return users[userIndex];
                }
                
                return null;
            } catch (e) {
                console.error('Ошибка обновления:', e);
                return null;
            }
        }

        function getAllUsers() {
            try {
                const usersData = safeGetItem('abucargo_users');
                return usersData ? JSON.parse(usersData) : [];
            } catch (e) {
                return [];
            }
        }

        function getAllOrders() {
            try {
                const ordersData = safeGetItem('abucargo_orders');
                return ordersData ? JSON.parse(ordersData) : [];
            } catch (e) {
                return [];
            }
        }

        function addOrder(userId, trackCode, status = "Ожидает получения") {
            try {
                const orders = getAllOrders();
                const newOrder = {
                    id: Date.now().toString(),
                    userId: userId,
                    trackCode: trackCode,
                    status: status,
                    dateAdded: new Date().toISOString()
                };
                
                orders.push(newOrder);
                safeSetItem('abucargo_orders', JSON.stringify(orders));
                return newOrder;
            } catch (e) {
                console.error('Ошибка добавления заказа:', e);
                return null;
            }
        }

        function updateOrder(orderId, updates) {
            try {
                const orders = getAllOrders();
                const orderIndex = orders.findIndex(o => o.id === orderId);
                
                if (orderIndex !== -1) {
                    orders[orderIndex] = { ...orders[orderIndex], ...updates };
                    safeSetItem('abucargo_orders', JSON.stringify(orders));
                    return orders[orderIndex];
                }
                
                return null;
            } catch (e) {
                console.error('Ошибка обновления заказа:', e);
                return null;
            }
        }

        function deleteOrder(orderId) {
            try {
                const orders = getAllOrders();
                const updatedOrders = orders.filter(order => order.id !== orderId);
                safeSetItem('abucargo_orders', JSON.stringify(updatedOrders));
            } catch (e) {
                console.error('Ошибка удаления заказа:', e);
            }
        }

        function searchUsers(query) {
            const users = getAllUsers();
            return users.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.phone.includes(query) ||
                user.code.toLowerCase().includes(query.toLowerCase())
            );
        }

        function getUserByCode(code) {
            const users = getAllUsers();
            return users.find(user => user.code === code);
        }

        // Адрес в Китае с кодом пользователя в начале и конце
        function getChinaAddress(code) {
            return `御玺${code}<br>15727306315<br>浙江省金华市义乌市北苑街道春晗二区36栋好运国际货运5697库入仓号:御玺${code}`;
        }

        function loginAsUser(userId) {
            const users = getAllUsers();
            const user = users.find(u => u.id === userId);
            if (user) {
                showDashboard(user);
            }
        }

        function generateTelegramText(user) {
            const pvzInfo = getPvzInfo(user.pvz);
            return `📃 Ваш профиль📃

🪪 Персональный КОД: ${user.code}
👤 ФИО: ${user.name}
📞 Номер: ${user.phone}
🏡 Адрес: 

📍 ПВЗ: ${pvzInfo.address}
📍 ПВЗ телефон: ${pvzInfo.phone}
📍 Часы работы: ${pvzInfo.hours}
📍 Локация на Карте: ${pvzInfo.map}

Адрес в Китае:
御玺${user.code}
15727306315
浙江省金华市义乌市北苑街道春晗二区36栋好运国际货运5697库入仓号:御玺${user.code}`;
        }

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const userDashboard = document.getElementById('userDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const loginFormElement = document.getElementById('loginFormElement');
        const registerFormElement = document.getElementById('registerFormElement');
        const showRegisterLink = document.getElementById('showRegister');
        const showLoginLink = document.getElementById('showLogin');
        const menuBtn = document.getElementById('menuBtn');
        const closeBtn = document.getElementById('closeBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
        const sections = document.querySelectorAll('.section');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminLogoutBtn = document.getElementById('adminLogoutBtn');
        const personalDataForm = document.getElementById('personalDataForm');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const addOrderForm = document.getElementById('addOrderForm');
        const adminAddOrderForm = document.getElementById('adminAddOrderForm');
        const adminNavButtons = document.querySelectorAll('.admin-nav button');
        const adminSections = document.querySelectorAll('.admin-section');
        const searchInput = document.getElementById('searchInput');
        const inTransitTable = document.getElementById('inTransitTable');
        const searchResultsTable = document.getElementById('searchResultsTable');
        const allUsersTable = document.getElementById('allUsersTable');
        const dashboardTitle = document.getElementById('dashboardTitle');
        const userCodeSpan = document.getElementById('userCodeSpan');
        const chinaAddress = document.getElementById('chinaAddress');
        const orderList = document.getElementById('orderList');
        const profileInfo = document.getElementById('profileInfo');
        const shareToTelegramBtn = document.getElementById('shareToTelegram');

        let currentUser = null;

        function setupEventListeners() {
            showRegisterLink.addEventListener('click', function(e) {
                e.preventDefault();
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
            });
            
            showLoginLink.addEventListener('click', function(e) {
                e.preventDefault();
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
            });
            
            loginFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                const phone = document.getElementById('loginPhone').value;
                const password = document.getElementById('loginPassword').value;
                
                const user = loginUser(phone, password);
                if (user) {
                    showDashboard(user);
                } else {
                    alert('Неверный номер телефона или пароль');
                }
            });
            
            registerFormElement.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const phone = document.getElementById('registerPhone').value;
                const password = document.getElementById('registerPassword').value;
                const pvz = document.getElementById('registerPvz').value;
                
                // Передаем телефон текущего админа для генерации кода
                const adminPhone = currentUser.phone;
                const newUser = registerUser(name, phone, password, pvz, adminPhone);
                if (newUser) {
                    alert(`Регистрация успешна! Ваш код: ${newUser.code}`);
                    showDashboard(newUser);
                }
            });
            
            menuBtn.addEventListener('click', function() {
                sidebar.classList.add('active');
            });
            
            closeBtn.addEventListener('click', function() {
                sidebar.classList.remove('active');
            });
            
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.getAttribute('data-section');
                    
                    sections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    document.getElementById(targetSection).classList.add('active');
                    sidebar.classList.remove('active');
                });
            });
            
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('abucargo_active_user');
                sessionStorage.removeItem('abucargo_active_user');
                loginForm.style.display = 'block';
                userDashboard.style.display = 'none';
                adminDashboard.style.display = 'none';
                registerForm.style.display = 'none';
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            });
            
            adminLogoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('abucargo_active_user');
                sessionStorage.removeItem('abucargo_active_user');
                loginForm.style.display = 'block';
                userDashboard.style.display = 'none';
                adminDashboard.style.display = 'none';
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            });
            
            personalDataForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('editName').value;
                const phone = document.getElementById('editPhone').value;
                const pvz = document.getElementById('editPvz').value;
                
                const updatedUser = updateUser(currentUser.id, { name, phone, pvz });
                if (updatedUser) {
                    currentUser = updatedUser;
                    const userData = JSON.stringify(currentUser);
                    safeSetItem('abucargo_active_user', userData);
                    sessionStorage.setItem('abucargo_active_user', userData);
                    updateUserInterface();
                    alert('Данные успешно обновлены');
                }
            });
            
            changePasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    alert('Пароли не совпадают');
                    return;
                }
                
                const updatedUser = updateUser(currentUser.id, { password: newPassword });
                if (updatedUser) {
                    currentUser = updatedUser;
                    const userData = JSON.stringify(currentUser);
                    safeSetItem('abucargo_active_user', userData);
                    sessionStorage.setItem('abucargo_active_user', userData);
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmPassword').value = '';
                    alert('Пароль успешно изменен');
                }
            });
            
            addOrderForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const trackCode = document.getElementById('trackCode').value;
                
                if (!trackCode) {
                    alert('Введите трек код');
                    return;
                }
                
                addOrder(currentUser.id, trackCode);
                document.getElementById('trackCode').value = '';
                alert('Заказ добавлен со статусом "Ожидает получения"');
                loadUserOrders();
            });
            
            adminAddOrderForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const userCode = document.getElementById('adminUserCode').value;
                const trackCode = document.getElementById('adminTrackCode').value;
                const status = document.getElementById('adminOrderStatus').value;
                
                const user = getUserByCode(userCode);
                if (!user) {
                    alert('Пользователь с таким кодом не найден');
                    return;
                }
                
                addOrder(user.id, trackCode, status);
                document.getElementById('adminUserCode').value = '';
                document.getElementById('adminTrackCode').value = '';
                alert('Заказ добавлен');
                loadInTransitData();
            });
            
            adminNavButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-admin-section');
                    
                    adminSections.forEach(section => {
                        section.classList.remove('active');
                    });
                    
                    document.getElementById(targetSection).classList.add('active');
                    
                    if (targetSection === 'inTransit') {
                        loadInTransitData();
                    } else if (targetSection === 'allUsers') {
                        loadAllUsersData();
                    }
                });
            });
            
            searchInput.addEventListener('input', function() {
                const query = this.value;
                if (query.length >= 2) {
                    const results = searchUsers(query);
                    displaySearchResults(results);
                } else {
                    searchResultsTable.innerHTML = '';
                }
            });

            shareToTelegramBtn.addEventListener('click', function() {
                const telegramText = generateTelegramText(currentUser);
                const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent('Ваш профиль Abu Cargo')}&text=${encodeURIComponent(telegramText)}`;
                window.open(telegramUrl, '_blank');
            });
        }

        function showDashboard(user) {
            currentUser = user;
            const userData = JSON.stringify(user);
            safeSetItem('abucargo_active_user', userData);
            sessionStorage.setItem('abucargo_active_user', userData);
            
            loginForm.style.display = 'none';
            registerForm.style.display = 'none';
            
            if (user.isAdmin) {
                adminDashboard.style.display = 'block';
                userDashboard.style.display = 'none';
                loadAdminData();
            } else {
                userDashboard.style.display = 'block';
                adminDashboard.style.display = 'none';
                updateUserInterface();
            }
        }

        function updateUserInterface() {
            dashboardTitle.textContent = `Abu Cargo — твой код ${currentUser.code}`;
            userCodeSpan.textContent = currentUser.code;
            chinaAddress.innerHTML = getChinaAddress(currentUser.code);
            
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editPhone').value = currentUser.phone;
            document.getElementById('editPvz').value = currentUser.pvz;
            
            updateProfileInfo();
            loadUserOrders();
        }

        function updateProfileInfo() {
            const pvzInfo = getPvzInfo(currentUser.pvz);
            
            profileInfo.innerHTML = `
                <p>🪪 <strong>Персональный КОД:</strong> ${currentUser.code}</p>
                <p>👤 <strong>ФИО:</strong> ${currentUser.name}</p>
                <p>📞 <strong>Номер:</strong> ${currentUser.phone}</p>
                <p>🏡 <strong>Адрес:</strong></p>
                <p>📍 <strong>ПВЗ:</strong> ${pvzInfo.address}</p>
                <p>📍 <strong>ПВЗ телефон:</strong> ${pvzInfo.phone}</p>
                <p>📍 <strong>Часы работы:</strong> ${pvzInfo.hours}</p>
                <p>📍 <strong>Локация на Карте:</strong> <a href="${pvzInfo.map}" target="_blank" style="color: white;">Открыть карту</a></p>
            `;
        }

        function loadUserOrders() {
            const orders = getAllOrders();
            const userOrders = orders.filter(order => order.userId === currentUser.id);
            
            orderList.innerHTML = '';
            
            if (userOrders.length === 0) {
                orderList.innerHTML = '<tr><td colspan="4" style="text-align: center;">Нет заказов</td></tr>';
                return;
            }
            
            userOrders.forEach(order => {
                const row = document.createElement('tr');
                const dateAdded = new Date(order.dateAdded).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${order.trackCode}</td>
                    <td>${order.status}</td>
                    <td>${dateAdded}</td>
                    <td>
                        <button class="btn btn-danger delete-order" data-order-id="${order.id}">Удалить</button>
                    </td>
                `;
                
                orderList.appendChild(row);
            });
            
            document.querySelectorAll('#orderList .delete-order').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    if (confirm('Удалить этот заказ?')) {
                        deleteOrder(orderId);
                        loadUserOrders();
                    }
                });
            });
        }

        function loadAdminData() {
            loadInTransitData();
            loadAllUsersData();
        }

        function loadInTransitData() {
            const orders = getAllOrders();
            const users = getAllUsers();
            
            inTransitTable.innerHTML = '';
            
            if (orders.length === 0) {
                inTransitTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">Нет заказов</td></tr>';
                return;
            }
            
            orders.forEach(order => {
                const user = users.find(u => u.id === order.userId);
                if (!user) return;
                
                const row = document.createElement('tr');
                const dateAdded = new Date(order.dateAdded).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.code}</td>
                    <td>${order.trackCode}</td>
                    <td>
                        <select class="status-select" data-order-id="${order.id}">
                            <option value="Ожидает получения" ${order.status === 'Ожидает получения' ? 'selected' : ''}>Ожидает получения</option>
                            <option value="В пути" ${order.status === 'В пути' ? 'selected' : ''}>В пути</option>
                            <option value="Получен" ${order.status === 'Получен' ? 'selected' : ''}>Получен</option>
                        </select>
                    </td>
                    <td>${dateAdded}</td>
                    <td>
                        <button class="btn btn-success save-order" data-order-id="${order.id}">Сохранить</button>
                        <button class="btn btn-danger delete-order" data-order-id="${order.id}">Удалить</button>
                    </td>
                `;
                
                inTransitTable.appendChild(row);
            });
            
            document.querySelectorAll('.save-order').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    const statusSelect = document.querySelector(`.status-select[data-order-id="${orderId}"]`);
                    
                    const updates = {
                        status: statusSelect.value
                    };
                    
                    updateOrder(orderId, updates);
                    alert('Статус заказа обновлен');
                    loadInTransitData();
                });
            });
            
            document.querySelectorAll('.delete-order').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    if (confirm('Удалить этот заказ?')) {
                        deleteOrder(orderId);
                        loadInTransitData();
                    }
                });
            });
        }

        function loadAllUsersData() {
            const users = getAllUsers().filter(user => !user.isAdmin);
            
            allUsersTable.innerHTML = '';
            
            if (users.length === 0) {
                allUsersTable.innerHTML = '<tr><td colspan="6" style="text-align: center;">Нет пользователей</td></tr>';
                return;
            }
            
            users.forEach(user => {
                const row = document.createElement('tr');
                const regDate = new Date(user.registrationDate).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${user.code}</td>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${user.pvz}</td>
                    <td>${regDate}</td>
                    <td>
                        <button class="btn btn-success login-as-user" data-user-id="${user.id}">Войти как пользователь</button>
                        <button class="btn btn-secondary edit-user" data-user-id="${user.id}">Изменить пароль</button>
                        <button class="btn btn-danger delete-user" data-user-id="${user.id}">Удалить</button>
                    </td>
                `;
                
                allUsersTable.appendChild(row);
            });
            
            document.querySelectorAll('.login-as-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    loginAsUser(userId);
                });
            });
            
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    changeUserPassword(userId);
                });
            });
            
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    if (confirm('Удалить этого пользователя?')) {
                        deleteUser(userId);
                        loadAllUsersData();
                    }
                });
            });
        }

        function changeUserPassword(userId) {
            const newPassword = prompt('Введите новый пароль:');
            if (newPassword) {
                updateUser(userId, { password: newPassword });
                alert('Пароль изменен');
            }
        }

        function displaySearchResults(results) {
            searchResultsTable.innerHTML = '';
            
            if (results.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center;">Пользователи не найдены</td>';
                searchResultsTable.appendChild(row);
                return;
            }
            
            results.forEach(user => {
                if (user.isAdmin) return;
                
                const row = document.createElement('tr');
                const regDate = new Date(user.registrationDate).toLocaleDateString('ru-RU');
                
                row.innerHTML = `
                    <td>${user.code}</td>
                    <td>${user.name}</td>
                    <td>${user.phone}</td>
                    <td>${user.pvz}</td>
                    <td>${regDate}</td>
                    <td>
                        <button class="btn btn-success login-as-user" data-user-id="${user.id}">Войти как пользователь</button>
                        <button class="btn btn-secondary edit-user" data-user-id="${user.id}">Изменить пароль</button>
                    </td>
                `;
                
                searchResultsTable.appendChild(row);
            });
            
            document.querySelectorAll('#searchResultsTable .login-as-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    loginAsUser(userId);
                });
            });
            
            document.querySelectorAll('#searchResultsTable .edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-user-id');
                    changeUserPassword(userId);
                });
            });
        }

        function deleteUser(userId) {
            const users = getAllUsers();
            const updatedUsers = users.filter(user => user.id !== userId);
            safeSetItem('abucargo_users', JSON.stringify(updatedUsers));
            
            const orders = getAllOrders();
            const updatedOrders = orders.filter(order => order.userId !== userId);
            safeSetItem('abucargo_orders', JSON.stringify(updatedOrders));
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Загрузка сайта...');
            
            initDatabase();
            
            let activeUser = null;
            try {
                const localUser = safeGetItem('abucargo_active_user');
                const sessionUser = sessionStorage.getItem('abucargo_active_user');
                
                activeUser = localUser || sessionUser;
                
                if (activeUser) {
                    const user = JSON.parse(activeUser);
                    console.log('Найден активный пользователь:', user.name);
                    showDashboard(user);
                } else {
                    console.log('Активный пользователь не найден');
                    loginForm.style.display = 'block';
                }
            } catch (e) {
                console.error('Ошибка загрузки сессии:', e);
                loginForm.style.display = 'block';
            }
            
            setupEventListeners();
        });
    </script>
</body>
  </html>
